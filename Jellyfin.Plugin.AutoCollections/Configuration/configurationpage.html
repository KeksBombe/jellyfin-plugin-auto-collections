<!doctype html>
<html>
  <head>
    <title>Auto Collections</title>
    <style>      .title-match-container {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      .match-type-container {
        width: 100px;
        margin-right: 10px;
      }
      .match-type-select {
        width: 100%;
      }
      .title-match-input {
        flex: 1;
        margin-right: 10px;
      }
      .collection-name-input {
        flex: 1;
        margin-right: 10px;
      }
      .case-sensitive-check {
        margin-right: 10px;
        display: flex;
        align-items: center;
      }
      .case-label {
        white-space: nowrap;
        margin-right: 5px;
      }
      .add-title-match-button {
        margin-bottom: 15px;
      }
      .remove-button {
        margin-left: 10px;
        min-width: 40px;
      }
      #title-match-pairs {
        margin-bottom: 20px;
      }
      .help-text {
        font-size: 0.9em;
        color: #888;
        margin-top: 5px;
        margin-bottom: 15px;
      }
    </style>
  </head>
  <body>
    <div
      data-role="page"
      class="page type-interior pluginConfigurationPage tbsConfigurationPage"
      data-require="emby-input,emby-button,emby-select,emby-checkbox"
    >
      <div data-role="content">
        <div class="content-primary">
          <form class="tbsConfigurationPage">
            <div class="page-header sectionTitleContainer flex align-items-center">
              <h2 class="sectionTitle">Auto Collections</h2>
              <a
                is="emby-linkbutton"
                class="raised button-alt headerHelpButton emby-button"
                target="_blank"
                href="https://github.com/johnpc/jellyfin-plugin-Auto-collections"
                >Help</a
              >
            </div>
            <div class="verticalSection">
              <div class="inputContainer">
                <label class="inputLabel inputLabelUnfocused" for="title-match-pairs">Auto Collections</label>
                <div class="help-text">
                  Create smart collections based on matching criteria. Select the type (Title, Genre, Studio, Actor, Director), 
                  enter the string to match, and provide an optional collection name.
                </div>
                <div id="title-match-pairs"></div>
                <div id="empty-collections-state" class="empty-state" style="display: none;">
                  <p>No auto collections configured yet. Add your first collection below.</p>
                </div>
              </div>                <button
                id="add-title-match-button"
                is="emby-button"
                type="button"
                class="raised add-title-match-button emby-button"
              >
                <span>Add Auto Collection</span>
              </button>
              
              <div class="page-actions">
                <button
                  id="saveConfiguration"
                  is="emby-button"
                  class="raised button-submit block action-button primary"
                >
                  <span>Save Changes</span>
                </button>
                <button
                  is="emby-button"
                  type="button"
                  class="raised block action-button"
                  id="sync-Auto-collections"
                  onclick="execute()"
                >
                  <span>Sync Collections Now</span>
                </button>
              </div>
            </div>
          </form>
          
          <!-- Toast notification element -->
          <div id="toast" class="toast"></div>
        </div>
      </div>      <script type="text/javascript">
        // Toast notification function
        function showToast(message, isError = false) {
          const toast = document.getElementById('toast');
          toast.textContent = message;
          toast.className = isError ? 'toast error' : 'toast';
          toast.classList.add('show');
          
          setTimeout(() => {
            toast.classList.remove('show');
          }, 3000);
        }
          function updateEmptyState() {
          const titleMatchPairs = document.querySelectorAll('.title-match-container');
          const emptyState = document.getElementById('empty-collections-state');
          
          if (titleMatchPairs.length === 0) {
            emptyState.style.display = 'block';
          } else {
            emptyState.style.display = 'none';
          }
        }
          function addNewCollection(e) {
          // Prevent default if event is provided (to prevent form submission)
          if (e) e.preventDefault();
          
          // Only add the element once
          const element = createTitleMatchPairElement();
          document.querySelector("#title-match-pairs").appendChild(element);
          updateEmptyState();
          
          // Return false to prevent any additional default behavior
          return false;
        }
          function createTitleMatchPairElement(titleMatch = '', collectionName = '', caseSensitive = false, matchType = 0) {
          // Ensure matchType is a number
          matchType = parseInt(matchType, 10) || 0;
          console.log('Creating element with matchType:', matchType);
          
          const container = document.createElement('div');
          container.className = 'title-match-container';
          
          // Create match type section
          const matchTypeContainer = document.createElement('div');
          matchTypeContainer.className = 'match-type-container';
          
          const matchTypeLabel = document.createElement('label');
          matchTypeLabel.className = 'input-label';
          matchTypeLabel.textContent = 'Match Type';
          
          const matchTypeSelect = document.createElement('select');
          matchTypeSelect.is = 'emby-select';
          matchTypeSelect.className = 'match-type-select';
            // Define match types with labels
          const matchTypes = [
            { value: '0', text: 'Title' },
            { value: '1', text: 'Genre' },
            { value: '2', text: 'Studio' },
            { value: '3', text: 'Actor' },
            { value: '4', text: 'Director' }
          ];          // Add match type options
          matchTypes.forEach(type => {
            const option = document.createElement('option');
            option.value = type.value;
            option.text = type.text;
            matchTypeSelect.appendChild(option);
          });
          
          // Set the selected value after adding all options
          const currentMatchType = parseInt(matchType, 10);
          console.log(`Setting select to match type: ${currentMatchType}`);
          
          // First set the value directly
          matchTypeSelect.value = currentMatchType.toString();
          
          // Then also set the selected property on the matching option
          const selectedOption = Array.from(matchTypeSelect.options).find(
            option => parseInt(option.value, 10) === currentMatchType
          );
          
          if (selectedOption) {
            selectedOption.selected = true;
            console.log(`Selected option: ${selectedOption.text}`);
          } else {
            console.log(`Could not find option for match type: ${currentMatchType}`);
          }
          
          matchTypeContainer.appendChild(matchTypeLabel);
          matchTypeContainer.appendChild(matchTypeSelect);          // This ensures the Emby select component is properly initialized
          setTimeout(() => {
            // Run initialization
            if (matchTypeSelect.embyInit) {
              matchTypeSelect.embyInit();
            } else if (window.EmbyWebComponents && window.EmbyWebComponents.autoFocus) {
              window.EmbyWebComponents.autoFocus(matchTypeSelect.parentNode);
            }
            
            // After Emby initialization, ensure our value is still selected
            // because Emby might override it during initialization
            const currentMatchType = parseInt(matchType, 10);
            matchTypeSelect.value = currentMatchType.toString();
            
            // Log for debugging
            console.log(`After initialization, select value should be ${currentMatchType}, and is: ${matchTypeSelect.value}`);
          }, 0);
          
          // Create match string input
          const titleMatchContainer = document.createElement('div');
          titleMatchContainer.className = 'input-field-container';
          
          const titleMatchLabel = document.createElement('label');
          titleMatchLabel.className = 'input-label';
          titleMatchLabel.textContent = 'Match String';
          
          const titleMatchInput = document.createElement('input');
          titleMatchInput.is = 'emby-input';
          titleMatchInput.type = 'text';
          titleMatchInput.className = 'title-match-input';
          titleMatchInput.value = titleMatch;
          
          titleMatchContainer.appendChild(titleMatchLabel);
          titleMatchContainer.appendChild(titleMatchInput);
          
          // Create collection name input
          const collectionNameContainer = document.createElement('div');
          collectionNameContainer.className = 'input-field-container';
          
          const collectionNameLabel = document.createElement('label');
          collectionNameLabel.className = 'input-label';
          collectionNameLabel.textContent = 'Collection Name';
          
          const collectionNameInput = document.createElement('input');
          collectionNameInput.is = 'emby-input';
          collectionNameInput.type = 'text';
          collectionNameInput.className = 'collection-name-input';
          collectionNameInput.placeholder = 'Optional - uses match string if empty';
          collectionNameInput.value = collectionName;
          
          collectionNameContainer.appendChild(collectionNameLabel);
          collectionNameContainer.appendChild(collectionNameInput);
          
          // Create case-sensitive checkbox
          const caseCheckContainer = document.createElement('div');
          caseCheckContainer.className = 'case-sensitive-container';
          
          const caseCheckboxWrapper = document.createElement('div');
          caseCheckboxWrapper.className = 'case-sensitive-check';
          
          const caseCheckbox = document.createElement('input');
          caseCheckbox.is = 'emby-checkbox';
          caseCheckbox.type = 'checkbox';
          caseCheckbox.className = 'case-sensitive-checkbox';
          caseCheckbox.id = `case-sensitive-${Date.now()}`;
          caseCheckbox.checked = caseSensitive;
          
          const caseLabel = document.createElement('label');
          caseLabel.className = 'case-label';
          caseLabel.setAttribute('for', caseCheckbox.id);
          caseLabel.textContent = 'Case Sensitive';
          
          caseCheckboxWrapper.appendChild(caseCheckbox);
          caseCheckboxWrapper.appendChild(caseLabel);
          caseCheckContainer.appendChild(caseCheckboxWrapper);
          
          // Create actions container (for remove button)
          const actionsContainer = document.createElement('div');
          actionsContainer.className = 'actions-container';
          
          const removeButton = document.createElement('button');
          removeButton.is = 'emby-button';
          removeButton.type = 'button';
          removeButton.className = 'remove-button';
          removeButton.innerHTML = '<span>✕</span>';
          removeButton.title = 'Remove this collection';
          
          removeButton.onclick = function() {
            container.style.opacity = '0';
            container.style.transform = 'translateY(-10px)';
            container.style.transition = 'all 0.3s ease';
            
            setTimeout(() => {
              container.remove();
              updateEmptyState();
            }, 300);
          };
          
          actionsContainer.appendChild(removeButton);
          
          // Add all components to container
          container.appendChild(matchTypeContainer);
          container.appendChild(titleMatchContainer);
          container.appendChild(collectionNameContainer);
          container.appendChild(caseCheckContainer);
          container.appendChild(actionsContainer);
          
          // Create a dynamic update for the placeholder text based on the selected match type
          const updatePlaceholder = (select) => {
            const matchType = parseInt(select.value, 10);
            const input = select.closest('.title-match-container').querySelector('.title-match-input');
            if (input) {
              switch(matchType) {
                case 1: // Genre
                  input.placeholder = 'Genre to match (e.g. Action, Comedy)';
                  break;
                case 2: // Studio
                  input.placeholder = 'Studio to match (e.g. Marvel, Paramount)';
                  break;
                case 3: // Actor
                  input.placeholder = 'Actor name to match (e.g. Tom Hanks)';
                  break;
                case 4: // Director
                  input.placeholder = 'Director name to match (e.g. Christopher Nolan)';
                  break;
                default: // Title
                  input.placeholder = 'Text in title to match (e.g. Star Wars)';
              }
            }
          };
          
          // Add change event to update placeholder when match type changes
          matchTypeSelect.addEventListener('change', () => {
            updatePlaceholder(matchTypeSelect);
          });
          
          // Set initial placeholder based on match type
          setTimeout(() => updatePlaceholder(matchTypeSelect), 0);
          
          return container;
        }
        
        function loadConfig() {
          window.ApiClient.getPluginConfiguration(
            "06ebf4a9-1326-4327-968d-8da00e1ea2eb" // Plugin Id
          )
            .then(function (config) {
              const titleMatchPairsContainer = document.querySelector("#title-match-pairs");
              titleMatchPairsContainer.innerHTML = '';
                
              // Check if we have the TitleMatchPairs property
              if (config.TitleMatchPairs && config.TitleMatchPairs.length > 0) {
                config.TitleMatchPairs.forEach(pair => {                  const element = createTitleMatchPairElement(
                    pair.TitleMatch, 
                    pair.CollectionName, 
                    pair.CaseSensitive, 
                    pair.MatchType !== undefined ? parseInt(pair.MatchType, 10) : 0 // Default to Title if not specified, ensure it's a number
                  );
                  titleMatchPairsContainer.appendChild(element);
                });
                updateEmptyState();
              } 
              else {
                // Show empty state UI
                updateEmptyState();
              }
            })
            .catch(function (error) {
              console.error(error);
              showToast('Error loading configuration', true);
              updateEmptyState();
            });
        }
        
        function saveConfig() {
          const titleMatchContainers = document.querySelectorAll('.title-match-container');
          const titleMatchPairs = [];
          
          titleMatchContainers.forEach(container => {
            const titleMatchInput = container.querySelector('.title-match-input');
            const collectionNameInput = container.querySelector('.collection-name-input');
            const caseSensitiveCheckbox = container.querySelector('.case-sensitive-checkbox');
            const matchTypeSelect = container.querySelector('.match-type-select');
            
            if (titleMatchInput.value.trim()) {              const titleMatch = titleMatchInput.value.trim();
              const collectionName = collectionNameInput.value.trim();
              const caseSensitive = caseSensitiveCheckbox.checked;
              const matchType = parseInt(matchTypeSelect.value, 10);
              
              console.log(`Saving collection with matchType: ${matchType}`);
              
              titleMatchPairs.push({
                TitleMatch: titleMatch,
                CollectionName: collectionName || null, // Use null if collection name is empty
                CaseSensitive: caseSensitive,
                MatchType: matchType
              });
            }
          });
          
          const config = {
            TitleMatchPairs: titleMatchPairs,
            // Keep these empty for backward compatibility
            TagTitlePairs: [],
            Tags: []
          };
          
          window.ApiClient.updatePluginConfiguration(
            "06ebf4a9-1326-4327-968d-8da00e1ea2eb",
            config
          )
            .then(() => {
              showToast('Configuration saved successfully');
            })
            .catch(function (error) {
              console.error(error);
              showToast('Error saving configuration', true);
            });
        }
        
        function execute() {
          var request = {
            url: ApiClient.getUrl("/AutoCollections/AutoCollections"),
            type: "POST",
          };

          ApiClient.fetch(request)
            .then(function () {
              showToast('Sync started successfully');
            })
            .catch(function () {
              showToast('An unexpected error occurred', true);
            });        }
        
        // Initialize the page
        function initPage() {
          loadConfig();
          
          // Add event listeners
          document.querySelector("#saveConfiguration").addEventListener("click", function(e) {
            e.preventDefault();
            saveConfig();
          });
          
          document.querySelector("#add-title-match-button").addEventListener("click", addNewCollection);
        }
        
        // Call init function immediately or when DOM is loaded
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initPage);
        } else {
          initPage();
        }
      </script>
    </div>
  </body>
</html>
